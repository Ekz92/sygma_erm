unit UListeFacture;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Data.FMTBcd, Data.DB, Data.SqlExpr,
  frxClass, frxDBSet, Vcl.Menus, Vcl.StdCtrls, Vcl.ExtCtrls, Vcl.Grids,
  Vcl.ComCtrls, Vcl.Buttons;

type
  TfrmListeFacture = class(TForm)
    GroupBox1: TGroupBox;
    Label2: TLabel;
    Label3: TLabel;
    SpeedButton1: TSpeedButton;
    Label4: TLabel;
    Label5: TLabel;
    Label6: TLabel;
    lbtotal: TLabel;
    lbtotpaye: TLabel;
    lbtotreste: TLabel;
    cbStatut: TComboBox;
    d1: TDateTimePicker;
    d2: TDateTimePicker;
    edCodeClt: TEdit;
    cbType: TComboBox;
    edVehicule: TEdit;
    St_listeFacture: TStringGrid;
    Panel1: TPanel;
    Button1: TButton;
    PopupMenu1: TPopupMenu;
    Consultation1: TMenuItem;
    Supprimer1: TMenuItem;
    RFactureListe: TfrxReport;
    frxRFactureListe: TfrxDBDataset;
    QFactureListe: TSQLQuery;
    QConsultation: TSQLQuery;
    frxDBConsultation: TfrxDBDataset;
    Rconsultation: TfrxReport;
    procedure FormCreate(Sender: TObject);
    procedure SpeedButton1Click(Sender: TObject);
  private
    { Déclarations privées }
  public
    { Déclarations publiques }
  end;

var
  frmListeFacture: TfrmListeFacture;

implementation

{$R *.dfm}

uses records, UDM;

procedure TfrmListeFacture.FormCreate(Sender: TObject);
begin
with St_listeFacture do
  begin
    Cells[0,0] := 'Date';
    Cells[1,0] := 'Facture';
    Cells[2,0] := 'Client';
    Cells[3,0] := 'Total';
    Cells[4,0] := 'Payée';
    Cells[5,0] := 'Reste';
    Cells[6,0] := 'Statut';
  end;

end;

procedure TfrmListeFacture.SpeedButton1Click(Sender: TObject);
var
  Psql, Statut : string;
  Factures : TFacturationArray;
  I: Integer;

  vtot,vtotp,vtotr : real;
begin
if cbStatut.Text = 'Payée' then Statut := 'PA' else
if cbStatut.Text = 'En attente' then Statut := 'AT' else
if cbStatut.Text = 'Forcée' then Statut := 'FO' else

if (cbStatut.Text = '') and (edCodeClt.Text='') and (cbType.ItemIndex=0) then
  Psql := ' where date_fact between '+QuotedStr(FormatDateTime('yyyy-mm-dd ',d1.Date)+'00:00:00')
          +' and '+QuotedStr(FormatDateTime('yyyy-mm-dd ',d2.Date)+'23:59:59')
          +' and type_fact = '+QuotedStr('Comptoir');

if (cbStatut.Text = '') and (edCodeClt.Text<>'') and (cbType.ItemIndex=0) then
  Psql := ' where date_fact between '+QuotedStr(FormatDateTime('yyyy-mm-dd ',d1.Date)+'00:00:00')
          +' and '+QuotedStr(FormatDateTime('yyyy-mm-dd ',d2.Date)+'23:59:59')
          +' and code_clt = '+QuotedStr(edCodeClt.Text)
          +' and type_fact='+QuotedStr('Comptoir')   ;

if (cbStatut.Text <> '') and (edCodeClt.Text<>'') and (cbType.ItemIndex=0) then
  Psql := ' where statut='+QuotedStr(Statut)
          +' and date_fact between '+QuotedStr(FormatDateTime('yyyy-mm-dd ',d1.Date)+'00:00:00')
          +' and '+QuotedStr(FormatDateTime('yyyy-mm-dd ',d2.Date)+'23:59:59')
          +' and code_clt = '+QuotedStr(edCodeClt.Text)
          +' and type_fact='+QuotedStr('Comptoir');

if (cbStatut.Text <> '') and (edCodeClt.Text='') and (cbType.ItemIndex=0) then
  Psql := ' where statut='+QuotedStr(Statut)
          +' and date_fact between '+QuotedStr(FormatDateTime('yyyy-mm-dd ',d1.Date)+'00:00:00')
          +' and '+QuotedStr(FormatDateTime('yyyy-mm-dd ',d2.Date)+'23:59:59')
          +' and type_fact = '+QuotedStr('Comptoir');

if (cbType.ItemIndex=1) and (cbStatut.Text = '') and (edCodeClt.Text='') and  (edVehicule.Text='')then
  Psql := ' where date_fact between '+QuotedStr(FormatDateTime('yyyy-mm-dd ',d1.Date)+'00:00:00')
          +' and '+QuotedStr(FormatDateTime('yyyy-mm-dd ',d2.Date)+'23:59:59')
          +' and type_fact = '+QuotedStr('Camion');

if (cbType.ItemIndex=1) and (cbStatut.Text <> '') and (edCodeClt.Text='') and  (edVehicule.Text='')then
  Psql := ' where statut='+QuotedStr(Statut)
          +' and date_fact between '+QuotedStr(FormatDateTime('yyyy-mm-dd ',d1.Date)+'00:00:00')
          +' and '+QuotedStr(FormatDateTime('yyyy-mm-dd ',d2.Date)+'23:59:59')
          +' and type_fact = '+QuotedStr('Camion');


if (cbType.ItemIndex=1) and (cbStatut.Text = '') and (edCodeClt.Text<>'') and  (edVehicule.Text='')then
  Psql := ' where date_fact between '+QuotedStr(FormatDateTime('yyyy-mm-dd ',d1.Date)+'00:00:00')
          +' and '+QuotedStr(FormatDateTime('yyyy-mm-dd ',d2.Date)+'23:59:59')
          +' and code_clt = '+QuotedStr(edCodeClt.Text)
          +' and type_fact='+QuotedStr('Camion')   ;

if (cbType.ItemIndex=1) and (cbStatut.Text <> '') and (edCodeClt.Text<>'') and  (edVehicule.Text='')then
  Psql := ' where date_fact between '+QuotedStr(FormatDateTime('yyyy-mm-dd ',d1.Date)+'00:00:00')
          +' and '+QuotedStr(FormatDateTime('yyyy-mm-dd ',d2.Date)+'23:59:59')
          +' and code_clt = '+QuotedStr(edCodeClt.Text)
          +' and statut = '+QuotedStr(Statut)
          +' and type_fact='+QuotedStr('Camion')   ;

if (cbType.ItemIndex=1) and (cbStatut.Text = '') and (edCodeClt.Text='') and  (edVehicule.Text<>'')then
  Psql := ' where date_fact between '+QuotedStr(FormatDateTime('yyyy-mm-dd ',d1.Date)+'00:00:00')
          +' and '+QuotedStr(FormatDateTime('yyyy-mm-dd ',d2.Date)+'23:59:59')
          +' and type_fact = '+QuotedStr('Camion')
          +' and vehicule = '+QuotedStr(edVehicule.Text);


if (cbType.ItemIndex=1) and (cbStatut.Text = '') and (edCodeClt.Text<>'') and  (edVehicule.Text<>'')then
  Psql := ' where date_fact between '+QuotedStr(FormatDateTime('yyyy-mm-dd ',d1.Date)+'00:00:00')
          +' and '+QuotedStr(FormatDateTime('yyyy-mm-dd ',d2.Date)+'23:59:59')
          +' and code_clt = '+QuotedStr(edCodeClt.Text)
          +' and type_fact='+QuotedStr('Camion')
          +' and vehicule = '+QuotedStr(edVehicule.Text)   ;


if (cbType.ItemIndex=1) and (cbStatut.Text <> '') and (edCodeClt.Text<>'') and  (edVehicule.Text<>'')then
  Psql := ' where date_fact between '+QuotedStr(FormatDateTime('yyyy-mm-dd ',d1.Date)+'00:00:00')
          +' and '+QuotedStr(FormatDateTime('yyyy-mm-dd ',d2.Date)+'23:59:59')
          +' and code_clt = '+QuotedStr(edCodeClt.Text)
          +' and statut = '+QuotedStr(Statut)
          +' and type_fact='+QuotedStr('Camion')
          +' and vehicule = '+QuotedStr(edVehicule.Text) ;

if (cbType.ItemIndex=1) and (cbStatut.Text <> '') and (edCodeClt.Text='') and  (edVehicule.Text<>'')then
  Psql := ' where date_fact between '+QuotedStr(FormatDateTime('yyyy-mm-dd ',d1.Date)+'00:00:00')
          +' and '+QuotedStr(FormatDateTime('yyyy-mm-dd ',d2.Date)+'23:59:59')
          +' and statut = '+QuotedStr(Statut)
          +' and type_fact='+QuotedStr('Camion')
          +' and vehicule = '+QuotedStr(edVehicule.Text) ;

  Factures := dm.SelectFactures(Psql +' and statut_canc = 0 order by date_fact desc');
  St_listeFacture.RowCount := Length(Factures)+1;

  vtot :=0;
  vtotp:=0;
  vtotr:=0;

  for I := Low(Factures) to High(Factures) do
    begin
      with St_listeFacture do
        begin
          Cells[0,i+1] := Factures[i].Sdate_fact;
          Cells[1,i+1] := Factures[i].SNum_fact;
          Cells[2,i+1] := Factures[i].Snom_clt;
          Cells[3,i+1] := FloatToStr(Factures[i].Rmnt_t);
          Cells[4,i+1] := FloatToStr(Factures[i].Rmnt_p);
          Cells[5,i+1] := FloatToStr(Factures[i].Rmnt_r);
          Cells[6,i+1] := Factures[i].Sstatut;
        end;
        vtot := vtot + Factures[i].Rmnt_t;
        vtotp:= vtotp + Factures[i].Rmnt_p;
        vtotr:= vtotr +Factures[i].Rmnt_r;
    end;
    if St_listeFacture.RowCount>1 then
      St_listeFacture.FixedRows := 1;

    lbtotal.Caption := FloatToStrF(vtot,TFloatFormat(ffNumber),15,2)   ;
    lbtotpaye.Caption := FloatToStrF(vtotp,TFloatFormat(ffNumber),15,2) ;
    lbtotreste.Caption := FloatToStrF(vtotr,TFloatFormat(ffNumber),15,2)

end;

end.
