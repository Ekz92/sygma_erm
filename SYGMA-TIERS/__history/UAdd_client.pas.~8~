unit UAdd_client;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.Menus, Vcl.Grids, Vcl.StdCtrls,
  Vcl.Buttons, Vcl.ExtCtrls;

type
  TfrmAdd_client = class(TForm)
    Label7: TLabel;
    Label8: TLabel;
    Panel1: TPanel;
    Label1: TLabel;
    Label2: TLabel;
    Label3: TLabel;
    Label4: TLabel;
    Label5: TLabel;
    SpeedButton1: TSpeedButton;
    SpeedButton2: TSpeedButton;
    Label10: TLabel;
    Label9: TLabel;
    MemoComment: TMemo;
    edNom: TEdit;
    edAdresse: TEdit;
    edTel: TEdit;
    edEmail: TEdit;
    edcodeclt: TEdit;
    cbTarif: TComboBox;
    edCodeTarif: TEdit;
    GroupBox1: TGroupBox;
    Label6: TLabel;
    edNomRech: TEdit;
    StringGrid1: TStringGrid;
    PopupMenu1: TPopupMenu;
    Consulter1: TMenuItem;
    Modifier1: TMenuItem;
    Supprimer1: TMenuItem;
    procedure FormActivate(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure FormShow(Sender: TObject);
    procedure SpeedButton1Click(Sender: TObject);
  private
    { Déclarations privées }
  public
    { Déclarations publiques }
  end;

var
  frmAdd_client: TfrmAdd_client;

implementation

{$R *.dfm}

procedure TfrmAdd_client.FormActivate(Sender: TObject);
begin
MemoComment.Clear;
edcodeclt.SetFocus;

end;

procedure TfrmAdd_client.FormClose(Sender: TObject; var Action: TCloseAction);
begin
cbTarif.Clear;
end;

procedure TfrmAdd_client.FormCreate(Sender: TObject);
begin
with StringGrid1 do
  begin
    Cells[0,0]:='Code';
    Cells[1,0]:='Nom';
    Cells[2,0]:='Tel';
    Cells[3,0]:='Adresse';
    Cells[4,0]:='E-mail';
    Cells[5,0]:='Comment.';
    Cells[6,0]:='Tarif'
  end;
end;

procedure TfrmAdd_client.FormShow(Sender: TObject);
var
  Clients : TClientArray;
  Psql : string;
  I: Integer;

  Tarifs : TTarifArray;
  //I: Integer;
  Psql_tarif :string;

begin
  Psql :=' order by id_clt desc';
  Clients:=dm.selectClients(Psql);
  StringGrid1.RowCount := Length(Clients)+1;
  for I := Low(Clients) to High(Clients) do
    begin
      with StringGrid1 do
        begin
          Cells[0,i+1] := Clients[i].SCodeClt;
          Cells[1,i+1] := Clients[i].SnomClt;
          Cells[2,i+1] := Clients[i].StelClt;
          Cells[3,i+1] := Clients[i].SadresseClt;
          Cells[4,i+1] := Clients[i].Smail;
          Cells[5,i+1] := Clients[i].ScommentClt;
          Cells[6,i+1] := Clients[i].STarif;
        end;
    end;
    if StringGrid1.RowCount>1 then StringGrid1.FixedRows := 1;
//************** Affichage du tarif********

  Psql_tarif :='';

  Tarifs := DM.SelectTarif(Psql_tarif);

  for I := Low(Tarifs) to High(Tarifs) do
    begin
      cbTarif.Items.Add(Tarifs[i].SDesignation_tarif);
    end;
end;

procedure TfrmAdd_client.SpeedButton1Click(Sender: TObject);
var
  Clt : TClient;
  cmpt :TCompteClient;
  Clts : TClientArray;
  Psql,
  sqlCc,
  sqlccd,
  SqlUpFact,
  SqlUpFactd : string;

  I: Integer;
  ExistClt,
  ChkSaisie : Boolean;
begin
// Vérification des chanmps

  if (edcodeclt.Text<>'') and (edNom.Text<>'') and
      (edAdresse.Text<>'')and(edTel.Text<>'')
        and (edCodeTarif.Text<>'') then

    ChkSaisie:= True else ChkSaisie := False;

  Psql := '';
  Clts := dm.selectClients(Psql);
  ExistClt:=False;

  for I := Low(Clts) to High(Clts) do
    begin
      if Clts[i].SCodeClt = edcodeclt.Text then
          begin
            ExistClt := True;
          end;
    end;

    with Clt do    {Insertion dans la table client}
      begin
        SCodeClt:=QuotedStr(Trim(edcodeclt.Text));
        SnomClt:=QuotedStr(trim(edNom.Text));
        SadresseClt:=QuotedStr(trim(edAdresse.Text));
        StelClt:=QuotedStr(edTel.Text);
        Smail:=QuotedStr(edEmail.Text);
        ScommentClt:=QuotedStr(MemoComment.Text);
        SZone:=QuotedStr('');
        STarif:=QuotedStr(edCodeTarif.Text);
      end;

      with cmpt do {Insertion dans la table des comptes}
        begin
          Scode_clt:=QuotedStr(trim(edcodeclt.Text));
          SNom_clt:=QuotedStr(trim(edNom.Text));
          SNum_cc:=QuotedStr(trim(edcodeclt.Text));
          RSolde:=0;
        end;

        sqlCc:='update tb_compte_client set nom_clt = '+Clt.SnomClt
                            +' where code_clt = '+Clt.SCodeClt;

        sqlCcd:='update tb_compte_client_detail set nom_clt = '+Clt.SnomClt
                            +' where code_clt = '+Clt.SCodeClt;

        SqlUpFact := ' update tb_facturation set nom_clt = '+QuotedStr(edNom.Text)
                            +' where code_clt = '+Clt.SCodeClt;

        SqlUpFactd := ' update tb_facturation_detail set nom_clt = '+QuotedStr(edNom.Text)
                            +' where code_clt = '+Clt.SCodeClt;

  if ChkSaisie=True then
    begin
      if (ExistClt=False) and (SpeedButton1.Caption='Ajouter') then
        begin
          dm.InsertClient(Clt);
          dm.InsertCompteClt(cmpt);
        end
      else if (ExistClt=True) and (SpeedButton1.Caption='Modifier') then
        begin
          if MessageDlg('Voulez-vous modifier les informations de ce client ?',mtInformation,[mbYes,mbNo],0)=mrYes then
           begin
            dm.UpdateClient(Clt);  {Modification dans la table client}
            dm.UpdateTable(sqlCc); {Modification dans la table des compte client}
            dm.UpdateTable(sqlccd);{ Modification dans la table details des comptes clients}
            dm.UpdateTable(SqlUpFact);{Modification dans la table facture}
            dm.UpdateTable(SqlUpFactd);{Modification dans la table du dtail de la facture}
           end;
        end
      else if (ExistClt=True) and (SpeedButton1.Caption='Ajouter') then
        begin
          MessageDlg('Il exite déjà un client avec ce code',mtError,[mbRetry],0);
        end;
    end else
      begin
        MessageDlg('Les champs marqué (*) sont obligatoires',mtError,[mbRetry],0);
        exit
      end;
  SpeedButton2.Click;
  Self.OnShow(sender);
end;

end.
